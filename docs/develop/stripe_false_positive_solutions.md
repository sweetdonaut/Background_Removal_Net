# 條紋偽陽性問題解決歷程

## 更新時間
- **2025-01-14**: 整理 8 月至今的條紋問題解決歷程

## 問題描述

在 8 月初完成主要優化後，模型在生產環境測試時發現新問題：
- **主要問題**：當圖案有條紋時，三通道的亮度變化導致模型誤判為缺陷
- **表現形式**：強烈的 false positive（偽陽性）反應
- **影響範圍**：帶有線條或條紋圖案的測試樣本

## 解決方案演進歷程

### 版本時間線

#### 版本 1：Edge Negative Dataloader (60f3621, 8/14)
**概念**：使用 Canny 邊緣檢測增強現有邊緣
- **實作方式**：
  - 檢測原圖邊緣 → 膨脹 → 高斯模糊
  - 三種增強模式：brightness、mixed、noise
  - 10% 機率額外加入條紋圖案
- **問題**：❌ 邏輯錯誤 - 依賴原圖已有邊緣才生成負樣本
- **程式碼量**：+1292 行

#### 版本 2：Patch Edge Function (73586a3)
**概念**：改進版本 1，先檢查是否有結構邊緣
- **實作方式**：
  - 新增 `_has_structural_edges` 函數
  - 邊緣像素比例 > 2% 才生成負樣本
  - 否則改為生成點缺陷
- **問題**：❌ 本末倒置 - 訓練集通常無線條，無法生成負樣本
- **程式碼量**：+402 行

#### 版本 3：Simple Line Defect (27bfb55) ✅
**概念**：直接生成合成線條作為負樣本
- **實作方式**：
  - 生成 1-3 條隨機線條（1-2 pixels 寬）
  - 智慧強度計算避免 clipping
  - Target 強度 100%，Ref1/Ref2 為 60%
  - GT mask 全零（線條非缺陷）
- **優點**：✅ 方向正確、實作簡潔
- **程式碼量**：-350 行（簡化）

#### 版本 4：Complex Line + Point (956c79b)
**概念**：過度工程化的解決方案
- **實作方式**：
  - 線條 + 點缺陷組合（`_generate_line_with_point_defects`）
  - 真實線條檢測與避讓（`_detect_real_lines`）
  - 複雜線條生成（2-6 pixels、軟邊緣、斑點變化）
  - 點缺陷避開線條位置
- **問題**：🤔 過度複雜、難以維護、效果存疑
- **程式碼量**：+553 行（爆炸性增長）

### 最終決策 (2025-01-14)

**回退到版本 3**，原因：
1. 版本 1-2 方向錯誤
2. 版本 3 簡潔有效
3. 版本 4 過度複雜

**提交記錄**：
```
commit 1a513e0: revert: Roll back dataloader to version 3 (simpler line generation)
- 移除 551 行複雜程式碼
- 保留簡單線條生成邏輯
```

## 目前狀態

### 資料生成策略
```
20% - 線條負樣本（1-3 條，GT mask = 0）
40% - 純點缺陷（3-8 個）
40% - 無修改
```

### 核心參數
- **缺陷數量**：3-8 個 per patch
- **缺陷強度**：[-80, -60, 60, 80]
- **線條寬度**：1-2 pixels
- **線條強度**：智慧計算（±30-50）

### 測試工具
1. **compare_models.py**：比較不同模型對各類缺陷的反應
2. **test_shape_penalty.py**：後處理形狀懲罰機制

## 經驗教訓

### 成功要素
1. ✅ **主動生成**：不依賴原圖特徵
2. ✅ **簡潔實作**：避免過度工程化
3. ✅ **負樣本訓練**：明確標記非缺陷（GT = 0）

### 失敗教訓
1. ❌ **依賴檢測**：依賴原圖邊緣的方法無效
2. ❌ **過度複雜**：複雜不等於有效
3. ❌ **缺乏驗證**：應在每次改動後立即測試

## 後續建議

### 短期改進
1. **微調版本 3**：
   - 調整線條寬度範圍（測試 1-3 pixels）
   - 優化強度計算策略
   - 增加線條變化（如輕微噪聲）

2. **加強測試**：
   - 收集更多條紋樣本
   - 建立標準測試集
   - 量化 false positive 率

### 長期方向
1. **形狀感知損失**：在訓練時直接懲罰線條狀預測
2. **對抗訓練**：使用真實條紋圖片作為負樣本
3. **後處理優化**：改進 shape penalty 機制

## 相關檔案

### 核心程式碼
- `dataloader.py`：資料載入與增強（版本 3）
- `dataloader_v4_backup.py`：版本 4 備份（參考用）
- `compare_models.py`：模型比較工具
- `test_shape_penalty.py`：形狀懲罰測試

### 文檔
- `development_record.md`：早期開發記錄（~8/3）
- `optimization_plan.md`：效能優化記錄（8/3）
- `inference_optimization.md`：推理優化記錄（8/3）

## 結論

經過四個版本的迭代，發現**簡單直接的方法往往最有效**。版本 3 的簡潔實作在保持程式碼可維護性的同時，提供了合理的解決方案。未來應基於實際測試結果進行微調，而非盲目增加複雜度。